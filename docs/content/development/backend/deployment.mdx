import { CodeBlock } from '@/components/CodeBlock'

# Deployment

## Overview

This document outlines the process for deploying the Rhesis backend to various environments. The application is containerized using Docker, making it deployable to any environment that supports containers.

## Prerequisites

Before deploying, ensure you have:

- Access to the target environment
- Docker installed (for local builds)
- Required environment variables and secrets
- Database migration plan

## Docker Deployment

### Building the Docker Image

The application include<CodeBlock filename="Terminal" language="bash">
{`# Build the Docker image
docker build -t rhesis-backend:latest ./apps/backend`}
</CodeBlock>er build -t rhesis-backend:latest ./apps/backend
<CodeBlock filename="Terminal" language="bash">
{`
### Running the Container

Run the<CodeBlock filename="Terminal" language="bash">
{`docker run -p 8000:8000 \
  --env-file ./apps/backend/.env.docker \
  rhesis-backend:latest`}
</CodeBlock>ps/backend/.env.docker \
  rhesis-backend:latest`}
</CodeBlock>

## Environment Configuration

### Production Environment Variables

For production deployments, ensure these environment variables are configured:

<CodeBlock filename="example.text" language="text">
{`# Database
SQLALCHEMY_DATABASE_URL=postgresql://user:password@host:port/database

# Authentication
AUTH0_DOMAIN=your-domain.auth0.com
AUTH0_AUDIENCE=your-audience
AUTH0_CLIENT_ID=your-client-id
AUTH0_CLIENT_SECRET=your-client-secret
AUTH0_SECRET_KEY=your-secret-key

# Application
LOG_LEVEL=INFO
FRONTEND_URL=https://app.rhesis.ai

# Celery
BROKER_URL=sqla+postgresql://celery-user:password@host:port/celery
CELERY_RESULT_BACKEND=db+postgresql://celery-user:password@host:port/celery`}
</CodeBlock>

## Deployment Environments

### Local Devel<CodeBlock filename="Terminal" language="bash">
{`# Run the Docker container locally
docker run -p 8000:8000 --env-file ./apps/backend/.env.docker rhesis-backend:latest`}
</CodeBlock>./apps/backend/.env.docker rhesis-backend:latest
<CodeBlock filename="example.text" language="text">
{`
### Google Cloud Run

Deploy to Google Cloud Run:

1. Buil<CodeBlock filename="Terminal" language="bash">
{`gcloud builds submit --tag gcr.io/project-id/rhesis-backend ./apps/backend`}
</CodeBlock> gcr.io/project-id/rhesis-b<CodeBlock filename="Terminal" language="bash">
{`gcloud run deploy rhesis-backend \
  --image gcr.io/project-id/rhesis-backend \
  --platform managed \
  --region us-central1 \
  --allow-unauthenticated \
  --set-env-vars "SQLALCHEMY_DB_HOST=/cloudsql/project-id:region:instance"`}
</CodeBlock>MY_DB_HOST=/cloudsql/project-id:reg<CodeBlock filename="Terminal" language="bash">
{`gcloud run services update rhesis-backend \
  --add-cloudsql-instances project-id:region:instance`}
</CodeBlock>dd-cloudsql-instances project-id:region:instance`}
</CodeBlock>

### AWS Deployment

De<CodeBlock filename="Terminal" language="bash">
{`aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin account-id.dkr.ecr.us-east-1.amazonaws.com
docker tag rhesis-backend:latest account-id.dkr.ecr.us-east-1.amazonaws.com/rhesis-backend:latest
docker push account-id.dkr.ecr.us-east-1.amazonaws.com/rhesis-backend:latest`}
</CodeBlock>cr.us-east-1.amazonaws.com/rhesis-backend:latest
<CodeBlock filename="example.text" language="text">
{`
2. Update the ECS task definition and service

## Database Migrations

Before deplo<CodeBlock filename="Terminal" language="bash">
{`# Inside the container or with access to the database
alembic upgrade head`}
</CodeBlock>with access to the database
alembic upgrade head`}
</CodeBlock>

For zero-downtime migrations:

1. Ensure migrations are backward compatible
2. Deploy the new version with migrations
3. Verify the application works correctly
4. If issues occur, be prepared to rollback

## Scaling

### Horizontal Scaling

The application is designed to scale horizontally:

- Stateless API design allows multiple instances
- Database connections use connection pooling
- Background tasks are handled by separate Celery workers

###<CodeBlock filename="Terminal" language="bash">
{`docker run \
  --env-file ./apps/backend/.env.docker \
  rhesis-backend:latest \
  celery -A rhesis.backend.worker worker --loglevel=info`}
</CodeBlock> -A rhesis.backend.worker worker --loglevel=info
<CodeBlock filename="Terminal" language="bash">
{`
## Monitoring and Logging

### Application Logs

The application logs to stdout/std<CodeBlock filename="Terminal" language="bash">
{`# View logs in Docker
docker logs container_id`}
</CodeBlock>h
# View logs in Docker
docker logs container_id`}
</CodeBlock>

### Health Checks

The applicat<CodeBlock filename="Terminal" language="bash">
{`curl http://localhost:8000/health`}
</CodeBlock>lth`:

```bash
curl http://localhost:8000/health
<CodeBlock filename="example.text" language="text">
{`
## Rollback Procedure

If deployment issues occur:

1. Identify the issue through logs and monitoring
2. Rollback to the previous known-good version by redeploying the previous im<CodeBlock filename="Terminal" language="bash">
{`alembic downgrade -1  # Downgrade one version`}
</CodeBlock>sh
alembic downgrade -1  # Downgrade one version`}
</CodeBlock>

## Security Considerations

- Store secrets securely using environment variables or secret management services
- Use HTTPS for all communications
- Implement network security policies to restrict access
- Regularly update dependencies to address security vulnerabilities
